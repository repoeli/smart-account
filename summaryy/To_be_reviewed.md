Phase 1 (US-005) kickoff: I verified the backend already exposes endpoints for validate/update/detail/reprocess, and the frontend OCR Results page calls the validate endpoint. To ensure persistence and visibility of review state, I updated the validation use case to set and persist a metadata.custom_fields.needs_review flag:
If the corrected OCR data validates and quality_score ≥ 0.8, needs_review = false; otherwise true.
On validation failure, we persist needs_review = true so the UI can surface it.
No linter errors introduced.
Next steps queued:
- [US-005] Verify audit capture for OCR edits is present and extend coverage where needed.
- [US-005] Confirm `needs_review` badge visibility end-to-end.
- Tests to write:
  - [US-005] Validation success/failure and needs_review propagation (unit/integration).
  - [US-005] Audit creation on validate/update (UserAuditLog).
  - [US-005] Reprocess endpoint integration tests: normal path and fallback path both persist without 500s.
  - [US-005] Reprocess audit: assert `UserAuditLog` row created with `event_type='receipt_reprocess'` and expected payload (engine/success/latency_ms/error).
  - [US-004] Storage migration: POST `/receipts/{id}/storage/migrate/` uploads to Cloudinary and updates telemetry; assert local `/media/...` and remote URLs both succeed; verify `file_url` becomes Cloudinary `secure_url` and `cloudinary_public_id` populated.
  - [US-004][US-005] Replace file flow: POST `/receipts/{id}/replace/` accepts image/PDF multipart; on success, `file_url` updated (Cloudinary), telemetry populated; when `reprocess=true` (default), OCR data persisted or `needs_review` set; audit row `receipt_replace` created.
  - [US-004] SHA-256 integrity: assert checksum is stored on upload/replace; optional test to compare client-computed checksum vs stored.
  - [US-005] Reprocess history endpoint: GET `/receipts/{id}/reprocess/history/?limit=10` returns latest entries; verify shape `{at, engine, success, latency_ms?, error?}` and ordering desc.
  - [US-005] Audit logs endpoint: GET `/audit/logs/?eventType=receipt_validate` returns recent logs; filter by `receipt_id` works; pagination (limit) respected.
  - [US-005] AuditPage UI: E2E to verify filters fetch correct subsets; details JSON is displayed; loading/error/empty states shown.
  - [US-005] OCR health: GET `/ocr/health/` returns structured status; mock up/down states; ensure latency fields present (optional snapshot tolerance).
  - [US-006][US-008][US-009] Transactions flow: POST create succeeds and GET list contains the new item; E2E from Receipt Detail navigates to Transactions list.
  - [US-008][US-009] Transactions list totals: verify income/expense totals per currency respect active filters (date/type/category) and remain consistent across pages.
  - [US-008][US-009] Transactions list sorting/pagination: verify limit/offset/hasNext/hasPrev correctness; E2E Previous/Next keep filters/sort in URL and update results.
  - [US-008][US-009] Transactions filter chips: verify removing chips updates URL and results; Clear-all resets offset and empties chips; totals banner always present.
  - [US-008][US-009] Transactions CSV export: verify `export.csv` reflects active filters/sort; headers match; at least one row for seeded data; merchant field populated when linked receipt exists.
  - [US-005] Transactions row deep-link: E2E that “Open OCR” navigates to `/receipts/:id/ocr` for rows with `receipt_id`.
  - [US-008][US-009] Delete transaction: E2E for optimistic delete with rollback on simulated failure; backend unit test for ownership enforcement.
  - [US-008][US-009] Duplicate to new: UI test to create a transaction from a duplicate modal and verify it appears in the list; values match with editable fields.
  - [US-008][US-009][US-010] Dashboard widgets: verify `/transactions/summary/` usage shows correct monthly Income/Expense/Net totals across currencies; add E2E.
  - [US-010] Summary grouping by month: regression test for `TruncMonth` output being `date` vs `datetime` (no AttributeError); verify keys are `YYYY-MM`.
  - [US-010] Dashboard summary retry: simulate first 500 then 200; verify UI shows banner then recovers after retry; “Retry” button triggers reload.
  - [US-010] KPI trend: with synthetic data, verify previous-period comparison computes correct diff for Income, Expense, and Net.
  - [US-005] Dashboard OCR health pill: mock up/down states and ensure pill text/color reflect engine availability.
  - [US-010] KPI deep links: E2E that clicking a month navigates to `/transactions` with that month’s `dateFrom/dateTo`; clicking a category navigates with `category` param plus the current date range.
  - [US-006][US-008][US-010] Dashboard category chips: verify chips appear for top categories when present; clicking a chip navigates to `/transactions` preserving `dateFrom/dateTo` and setting `category`; verify no chips render and the “No data” overlays show when the dataset is empty.
  - [US-006] Categories: E2E category dropdown hydrates from `/categories/`, falls back gracefully; ensure selected category filters list and persists via URL/localStorage.
  - [US-006] Category Suggestion: with seeded transactions for a merchant, `GET /categories/suggest?merchant=<name>` should return the most frequent prior category; if none, heuristic may return a default; always 200 with `{success:true}`.
  - [US-006] UI hint: `ReceiptDetailPage` displays a suggested category chip when API returns one; verify it appears/disappears as expected and survives reload.
  - [US-008][US-009] Receipt→Transaction 1:1 guard (no duplicates):
    - UI: disable "Create Transaction" button on `ReceiptDetailPage` when a transaction already exists for the receipt; surface a tooltip/explanatory note. Do NOT change DB yet.
    - API option (preferred, no DB change): support `GET /transactions/?receipt_id=<id>&limit=1` to check existence; or include `has_transaction` in `GET /receipts/:id`. Decide one path and implement.
    - E2E: create once → button disabled on reload; attempting again does nothing; transactions list remains single entry.
    - Later (DB hardening): add unique partial index on `transactions(receipt_id)` WHERE receipt_id IS NOT NULL. Migration + backfill/validation. [US-008][US-009]
    - Finalization reminder (end of project phase): implement a DB-level uniqueness constraint to enforce one transaction per receipt. Ensure existing data is backfilled/validated and add a safe migration path. [US-008][US-009]
    - UX enhancement: Receipts list should display a small “Converted” badge for receipts with an existing transaction. Current implementation performs per-card background checks; optimize by enriching list API items with `has_transaction` to avoid N queries. Document API shape and add caching where appropriate.
  - [US-008][US-009] Inline category edit (Transactions):
    - Backend: ensure PATCH `/transactions/:id` supports updating `category` with ownership checks and returns `{success}`.
    - Frontend: inline editor should optimistically update and rollback on error; dropdown hydrates from `/categories/` with fallback to free-text when not available.
  - [US-008][US-009] Transaction editing: backend PATCH allows updating description, amount, currency, type, transaction_date, and category. Add unit/integration tests (ownership, validation, date normalization) and E2E happy path from Transactions table inline editing and a future edit form.
  - [US-008][US-009] Frontend Edit modal: E2E to open, change fields, save, see updated row; simulate validation error (amount<=0) and assert error toast/no state change.
  - [US-008][US-009] Tests: Backend `receipt_id` filter → verify 0/1 results on `/transactions/?receipt_id=<id>`; include mixed dataset cases.
  - [US-008][US-009] Regression test: ensure `/transactions` list handles non-dict/nullable `receipt.ocr_data` without 500 and returns items with `merchant=null` gracefully.
  - [US-008][US-009] Tests: Frontend E2E → Create transaction from Receipt Detail, reload detail, assert “Create Transaction” is disabled and shows explanatory note; verify only one row appears in `/transactions`.
  - [US-008][US-009] Optional UX: show a small “Converted” badge on receipts that already have a transaction. Implement via detail enrichment (`has_transaction`) or list-row check using `/transactions/?receipt_id` on demand.
  - [US-013][US-014] Stripe wiring: unit/integration tests to return no-op when keys missing; when keys present (mocked), verify Checkout URL is returned; webhook signature verification success/failure cases.
  - Add tests for `GET /subscriptions/plans/`: with Stripe mocked, verify recurring prices listed with fields (id, nickname, currency, unit_amount, interval); when Stripe disabled, env price IDs are returned. Ensure `publishable_key` included.
  - Frontend E2E: Subscription plan list renders; clicking Subscribe for a plan opens Checkout URL; default checkout works when no plans are listed.
  - Frontend E2E: Subscription plan list renders exactly three plans (Basic, Premium, Platinum) based on env price ids; the active plan shows a "Current" badge and its button is disabled; clicking Subscribe on another plan opens Checkout and redirects back to `/subscription` success/cancel routes.
  - [US-013][US-015] Clients plan gating: tests that Basic users receive 403 `plan_restricted` on `GET/POST /clients`, Premium users succeed.
  - Webhook persistence: unit/integration tests that `checkout.session.completed` and `customer.subscription.*` events update `User.subscription_status`, `subscription_tier` (mapped by env price ids), and Stripe linkage fields (`stripe_customer_id`, `stripe_subscription_id`, `subscription_price_id`).
  - Add endpoint test for `GET /subscriptions/status/` returning current user’s tier/status and ids.
  - Frontend E2E: Subscription page shows current status and updates after webhook-simulated state change.
  - Dashboard E2E: Clients KPI shows count from `/clients/count/` and navigates to `/clients`; subscription chip reflects status and tier; OCR pill remains.
  - Frontend plan gating UX:
    - ClientsPage: simulate 403 to verify upgrade CTA and disabled Create.
    - ReceiptUploadPage: usage bar renders from `/subscriptions/usage/`; button disables when limit reached; 403 `plan_limit_reached` shows upgrade CTA.
    - TransactionsPage: CSV export shows friendly toast on 403 and hints to upgrade.
  - Stripe customer continuity: tests to assert `create_checkout_session` and `create_billing_portal` pass a stable customer (found or created by email) and that returned `customer_id` surfaces.
  - Add tests for `GET /subscriptions/current/` (when Stripe enabled) and `GET /subscriptions/usage/` for receipt counts vs tier limits.
  - Add tests for `GET /subscriptions/invoices/` listing invoice attributes (id, created, status, amount_due, urls) and UI table rendering.
  - Plans enrichment: verify `/subscriptions/plans/` includes `product_id`, `product_name`, `product_metadata`, `image`, and `payment_link_url` mapping for known prices.
  - Frontend: verify refined `isCurrentPlan` logic correctly marks Basic (including free trial) as current using `price_id`, `product_id`, and tier/status fallbacks.
  - [US-013][US-014] CSV export plan gating: tests that Basic receives 403 `plan_restricted`, Premium succeeds.
  - [US-013][US-014] Receipt upload monthly limits: tests that when `usage.receipts_this_month >= max_receipts`, `POST /receipts/upload/` returns 403 `plan_limit_reached`; also verify unlimited plan behavior.
  - E2E Subscription wizard: plan cards render features from `product_metadata.features`, badges (Popular/Current), trial days, and both actions (Payment Link/Choose plan) work; confirm dialog appears and redirects to Stripe Checkout.
  - Header E2E: subscription chip renders for authenticated users; reflects mocked status changes.
  - [US-015] Clients: backend tests for `GET/POST /clients/` (ownership scoping, validation errors, creation success); migration applied and model present.
  - Add tests for `GET/PATCH/DELETE /clients/:id` (ownership scoping, validation, deletion) and UI flows once wired on the ClientsPage.
  - Transactions filters: tests to ensure `client_id` filter narrows results, persists through pagination, and is included in CSV export.
  - Frontend E2E: ClientsPage inline edit saves and reflects changes; delete removes the row with confirmation; error paths show toasts.
  - [US-015] Future tasks: add update/delete endpoints and tie clients into receipts/transactions scoping in later iterations.
  - [US-015] ClientsPage E2E: list renders, create form validates name, successful create reloads list and shows toast; error banner on 500.
  - [US-015][US-008][US-009] Transactions client link: tests that `client_id` is persisted on create/update, filterability later (future), and ownership enforced.

- [US-010] Dashboard Phase – next big tasks
  - Add date range presets (This month, Last month, This year, Custom) controlling `/transactions/summary/` queries.
  - Extend summary API to support `groupBy=month|category|merchant` and return time-series suitable for charts. [US-008][US-009][US-010] (implemented: merchant; tests pending)
  - Frontend charts: income vs expense over time (line/area), category breakdown (pie/donut), top merchants (bar). [US-010]
  - Performance (NFR): cache summary responses server-side (e.g., 60s in-memory) and ensure p95 < 300ms; add simple timing logs. [US-010]
  - Tests: backend summary grouping/caching; frontend E2E to validate filters reflect in charts and totals. [US-010]
  - Tests: Dashboard custom date range presets persist across reload; summary reflects selected dates; error banner shown on 500s.
  - Tests: Transactions list timing logs do not alter response; totals remain consistent with filters.